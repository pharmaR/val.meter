<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Adding a Metric • val.meter</title>
<script src="../lightswitch.js"></script><script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Adding a Metric">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top " aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">val.meter</a>

    <small class="nav-text text-danger me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="Unreleased version">0.0.0.9000</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/adding-metric.html">Adding a Metric</a></li>
    <li><a class="dropdown-item" href="../articles/internals-overview.html">Internals Overview</a></li>
    <li><a class="dropdown-item" href="../articles/repository-integrations.html">Repository Integrations</a></li>
    <li><a class="dropdown-item" href="../articles/riskmetric-comparison.html">riskmetric Comparison</a></li>
  </ul>
</li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/pharmaR/val.meter/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-lightswitch" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true" aria-label="Light switch"><span class="fa fa-sun"></span></button>
  <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="dropdown-lightswitch">
<li><button class="dropdown-item" data-bs-theme-value="light"><span class="fa fa-sun"></span> Light</button></li>
    <li><button class="dropdown-item" data-bs-theme-value="dark"><span class="fa fa-moon"></span> Dark</button></li>
    <li><button class="dropdown-item" data-bs-theme-value="auto"><span class="fa fa-adjust"></span> Auto</button></li>
  </ul>
</li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Adding a Metric</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/pharmaR/val.meter/blob/main/vignettes/adding-metric.Rmd" class="external-link"><code>vignettes/adding-metric.Rmd</code></a></small>
      <div class="d-none name"><code>adding-metric.Rmd</code></div>
    </div>

    
    
<style type="text/css">
[data-bs-theme="dark"] main img {
  filter: invert(1);
}
</style>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://pharmar.github.io/val.meter">val.meter</a></span><span class="op">)</span></span></code></pre></div>
<p>Whether adding a metric in a script or supplementing
<code>val.meter</code> with new metrics from a supporting package, we’ll
add new metrics all the same way. The only function we need to know is
<code><a href="../reference/pkg_data.html">impl_data()</a></code>, which registers new data within the data
collection process and optionally surfaces it as a metric.</p>
<div class="section level2">
<h2 id="a-simple-metric">A simple metric<a class="anchor" aria-label="anchor" href="#a-simple-metric"></a>
</h2>
<p>For simplicity, we’ll start with a rather trivial metric - using the
number of characters in a package name as a (poor) heuristic for package
quality.</p>
<p>Since package name is something that all packages will have, we can
easily implement this metric for all packages.</p>
<div class="section level3">
<h3 id="accessing-package-data">Accessing package data<a class="anchor" aria-label="anchor" href="#accessing-package-data"></a>
</h3>
<p>Before we can calculate a package name’s length, we first need to
access information about a package. There are a couple ways to do this!
We can take a look at all the package data that is available by using
the <code><a href="../reference/metrics.html">metrics()</a></code> function. However, we need to pass
<code>all = TRUE</code> in order to include any internally calculated
data.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="fu"><a href="../reference/metrics.html">metrics</a></span><span class="op">(</span>all <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "r_cmd_check"             "desc"                   </span></span>
<span><span class="co">#&gt; [3] "archive_md5"             "name"                   </span></span>
<span><span class="co">#&gt; [5] "version"                 "r_cmd_check_error_count"</span></span>
<span><span class="co">#&gt; [7] "downloads_total"         "dependency_count"</span></span></code></pre></div>
<p>Sure enough, <code>"name"</code> is in the list. We can learn a bit
more about it by pulling this entry from our metrics:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">m</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/metrics.html">metrics</a></span><span class="op">(</span>all <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="va">m</span><span class="op">$</span><span class="va">name</span></span>
<span><span class="co">#&gt; <span style="font-weight: bold;">Package name </span><span style="font-weight: 100;">&lt;character&gt;</span></span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="implementing-data">Implementing data<a class="anchor" aria-label="anchor" href="#implementing-data"></a>
</h3>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/pkg_data.html">impl_data</a></span><span class="op">(</span></span>
<span>  <span class="st">"name_character_count"</span>,</span>
<span>  title <span class="op">=</span> <span class="st">"Package Name Character Count"</span>,</span>
<span>  <span class="kw">function</span><span class="op">(</span><span class="va">pkg</span>, <span class="va">...</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/nchar.html" class="external-link">nchar</a></span><span class="op">(</span><span class="va">pkg</span><span class="op">$</span><span class="va">name</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>Already, we can see that it is added to our list of
<code><a href="../reference/metrics.html">metrics()</a></code></p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">m</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/metrics.html">metrics</a></span><span class="op">(</span>all <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="va">m</span><span class="op">$</span><span class="va">name_character_count</span></span>
<span><span class="co">#&gt; <span style="font-weight: bold;">Package Name Character Count </span><span style="font-weight: 100;">&lt;ANY&gt;</span></span></span></code></pre></div>
<p>After being registered, we can immediately derive this piece of data
for a <code><a href="../reference/pkg.html">pkg()</a></code> object.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">p</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/random_pkg.html">random_pkg</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">p</span><span class="op">$</span><span class="va">name</span></span>
<span><span class="co">#&gt; [1] "incrediblesurvival"</span></span></code></pre></div>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">p</span><span class="op">$</span><span class="va">name_character_count</span></span>
<span><span class="co">#&gt; [1] 18</span></span></code></pre></div>
<p><code><a href="../reference/pkg_data.html">impl_data()</a></code> registers the necessary methods related to
this piece of data, which <code>val.meter</code> uses internally to
record metadata and the derivation function.</p>
</div>
<div class="section level3">
<h3 id="making-our-data-a-metric">Making our data a metric<a class="anchor" aria-label="anchor" href="#making-our-data-a-metric"></a>
</h3>
<p>Data and metrics are largely the same. We can convert data into a
metric by passing <code>metric = TRUE</code> to our
<code>impl_data</code> call. When we do, we’ll get stopped by a few
initial errors, which impose additional constraints on our
implementation. Let’s step through that process.</p>
<div class="section level4">
<h4 id="re-implementing-data">Re-implementing data<a class="anchor" aria-label="anchor" href="#re-implementing-data"></a>
</h4>
<p>The first thing we’ll see is that data methods can’t be naively
overwritten.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/pkg_data.html">impl_data</a></span><span class="op">(</span></span>
<span>  <span class="st">"name_character_count"</span>,</span>
<span>  title <span class="op">=</span> <span class="st">"Package Name Character Count"</span>,</span>
<span>  metric <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  <span class="kw">function</span><span class="op">(</span><span class="va">pkg</span>, <span class="va">...</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/nchar.html" class="external-link">nchar</a></span><span class="op">(</span><span class="va">pkg</span><span class="op">$</span><span class="va">name</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; Error in impl_data_info(name = name, ..., overwrite = overwrite, quiet = quiet): data info for 'name_character_count' is already implemented. Use overwrite=TRUE to modify.</span></span></code></pre></div>
<p>Following the suggestion in the error message, we see that we need to
confirm that we want to overwrite our existing data. Generally this is
only needed when you’re developing a metric and want to iterate on the
implementation.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/pkg_data.html">impl_data</a></span><span class="op">(</span></span>
<span>  <span class="st">"name_character_count"</span>,</span>
<span>  title <span class="op">=</span> <span class="st">"Package Name Character Count"</span>,</span>
<span>  metric <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  overwrite <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  <span class="kw">function</span><span class="op">(</span><span class="va">pkg</span>, <span class="va">...</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/nchar.html" class="external-link">nchar</a></span><span class="op">(</span><span class="va">pkg</span><span class="op">$</span><span class="va">name</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; Error in (function (self, value) : metric data must have an atomic data class</span></span></code></pre></div>
<p>The next thing we’ll see is that metric data has some additional
constraints imposed on the accepted data class. Metrics should be
summarized, straightforward data in an easy-to-use format, and for that
we require that they are “atomic” (see <code><a href="https://rdrr.io/r/base/vector.html" class="external-link">?base::atomic</a></code> for
details on exactly what qualifies). In short, atomic data are your
typical variable values - numbers, characters and logicals.</p>
<p>For metrics, we must declare what type our metric will be. This is
checked each time the metric is calculated to make sure we can operate
on this data with confidence. <code>val.meter</code> uses
<code>S7</code> to manage methods and we prefer to use
<code>S7::class_*</code> objects to characterize these classes.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/pkg_data.html">impl_data</a></span><span class="op">(</span></span>
<span>  <span class="st">"name_character_count"</span>,</span>
<span>  title <span class="op">=</span> <span class="st">"Package Name Character Count"</span>,</span>
<span>  metric <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  class <span class="op">=</span> <span class="fu">S7</span><span class="fu">::</span><span class="va"><a href="https://rconsortium.github.io/S7/reference/base_classes.html" class="external-link">class_integer</a></span>,</span>
<span>  overwrite <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  <span class="kw">function</span><span class="op">(</span><span class="va">pkg</span>, <span class="va">...</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/nchar.html" class="external-link">nchar</a></span><span class="op">(</span><span class="va">pkg</span><span class="op">$</span><span class="va">name</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; Overwriting method pkg_data_info(S3&lt;pkg_data_field_name_character_count/pkg_data_field&gt;)</span></span>
<span><span class="co">#&gt; Overwriting method pkg_data_derive(&lt;val.meter::pkg&gt;, &lt;val.meter::resource&gt;, S3&lt;pkg_data_field_name_character_count/pkg_data_field&gt;)</span></span></code></pre></div>
<p>And finally, we can again confirm that we’ve registered our metric.
This time we can avoid passing <code>all = TRUE</code>, as we’ve now
registered a metric.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">m</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/metrics.html">metrics</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">m</span><span class="op">$</span><span class="va">name_character_count</span></span>
<span><span class="co">#&gt; <span style="font-weight: bold;">Package Name Character Count </span><span style="font-weight: 100;">&lt;integer&gt;</span></span></span></code></pre></div>
</div>
</div>
</div>
<div class="section level2">
<h2 id="a-real-world-metric">A real-world metric<a class="anchor" aria-label="anchor" href="#a-real-world-metric"></a>
</h2>
<p>In practice, metrics can be a bit messier than simply the name of a
package. There are a couple key considerations when implementing a
non-trivial metric:</p>
<ol style="list-style-type: decimal">
<li>
<em>how</em> is the metric derived? Is the ability to calculate this
metric limited by <em>how</em> we refer to this package?</li>
<li>
<em>what dependencies</em> are needed to derive this metric? Do we
need to declare additional Suggested dependencies?</li>
<li>
<em>what capabilities</em> are needed? Do we need to do anything
that a user should have to opt-in to?</li>
<li>(optional) <em>what tags</em> do we want to use for this metric?
This may help the discoverability of our metric.</li>
</ol>
<p>Sometimes they depend on <em>how</em> you got your package. For
example, R will not install tests alongside a package by default, so
maybe we want to return <code>NA</code> for unit test coverage in
situations where a package has no <code>tests</code> directory in the
install library, but try to calculate something meaningful if we are
installing a fresh package from <code>CRAN</code>.</p>
<p><code>val.meter</code> refers to the possible origins of packages as
<code>resources</code>. These encompass any source for package data.
This could be the CRAN package page, a <code>git</code> repository
address, a local <code>.tar.gz</code> package archive or local
directory, among plenty of other options. When using
<code>val.meter</code>, you get to choose which of these are permissible
resources. For now, we only need to know that <code>resources</code> may
have access to different information about a package so metric
derivations may only be possible using certain resources.</p>
<p>Further, we can declare our additional <code>suggests()</code>
dependencies. These will be consistently communicated so that end users
are made aware that their available metrics are limited.</p>
<p>Similarly, we need to annotate any required capabilities so that end
users must opt-in to metrics that require these capabilities by
providing the necessary <code><a href="../reference/permissions.html">permissions()</a></code>.</p>
<p>And finally, if we want to make our metric discoverable, we can
provide it with any associated <code><a href="../reference/tags.html">tags()</a></code>.</p>
<p>Let’s implement a rigorous metric, which will surface vulnerabilities
using the <code>oysteR</code> package.</p>
<div class="section level3">
<h3 id="planning-our-metric">Planning our metric<a class="anchor" aria-label="anchor" href="#planning-our-metric"></a>
</h3>
<p><code>oysteR</code> provides a very useful interface for querying the
Sonatype vulnerability database. In our case, we can use a known example
to see how vulnerabilities might be reported:</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">oysteR</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/oysteR/man/audit.html" class="external-link">audit</a></span><span class="op">(</span><span class="st">"haven"</span>, version <span class="op">=</span> <span class="st">"0.1.1"</span>, type <span class="op">=</span> <span class="st">"cran"</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">ℹ</span> Using cached results for 0 packages</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; ── <span style="font-weight: bold;">Calling sonatype API: https://www.sonatype.com/</span> ──</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; → No Sonatype tokens found</span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">ℹ</span> Calling API: batch 1 of 1</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; ── <span style="font-weight: bold;">Vulnerability overview</span> ──</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">ℹ</span> 1 package was scanned</span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">ℹ</span> 1 package was found in the Sonatype database</span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">ℹ</span> 1 package had known vulnerability</span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">ℹ</span> A total of 3 known vulnerabilities were identified</span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">ℹ</span> See https://github.com/sonatype-nexus-community/oysteR/ for details.</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 1 × 8</span></span></span>
<span><span class="co">#&gt;   package version type  oss_package        description reference vulnerabilities</span></span>
<span><span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>              <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>       <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;list&gt;</span>         </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span> haven   0.1.1   cran  pkg:cran/haven@0.… <span style="color: #949494;">"</span>haven:  I… https://… <span style="color: #949494;">&lt;list [3]&gt;</span>     </span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># ℹ 1 more variable: no_of_vulnerabilities &lt;int&gt;</span></span></span></code></pre></div>
<blockquote>
<p><strong>Note: <code>haven</code> is a pillar of regulatory
reporting!</strong></p>
<p>As we all know, some regulated industries have a legacy of using
proprietary data formats. Because of their closed-source nature, the
exact dissection of these data must be reverse-engineered.
<code>haven</code> goes through extreme lengths to do this as rigorously
as possible.</p>
</blockquote>
<p>We can see from the output that <code>haven</code> historically had a
few vulnerabilities reported. But we can also see a fair amount of
information provided by <code>oysteR</code>.</p>
</div>
<div class="section level3">
<h3 id="implementing-intermediate-data">Implementing intermediate data<a class="anchor" aria-label="anchor" href="#implementing-intermediate-data"></a>
</h3>
<p>Which data do we want to use as our metric? For now, let’s implement
just the number of vulnerabilities - but let’s also pave the way for
ourselves to add other metrics based on this result later. To do this,
let’s first gather the output of <code>oysteR</code> as intermediate
data, which we’ll then use to derive our metrics as summarizing
data.</p>
<p>What’s important to note is that <code>oysteR</code> operates on
packages from <code>CRAN</code>, so we should be extra careful about not
assuming that packages installed locally are the same as those coming
from <code>CRAN</code>. There are tens of thousands of packages on
<code>CRAN</code> and we don’t want to accidentally report that a
package has no vulnerabilities just because it shares a name with one of
them.</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/pkg_data.html">impl_data</a></span><span class="op">(</span></span>
<span>  <span class="st">"oysteR_vulnerability_df"</span>,</span>
<span></span>
<span>  <span class="co"># declare our suggested dependency on {oysteR}</span></span>
<span>  suggests <span class="op">=</span> <span class="st">"oysteR"</span>,</span>
<span></span>
<span>  <span class="co"># require that users opt-in to network requests as part of this data</span></span>
<span>  permissions <span class="op">=</span> <span class="fu"><a href="../reference/permissions.html">permissions</a></span><span class="op">(</span><span class="st">"network"</span><span class="op">)</span>,</span>
<span></span>
<span>  <span class="co"># assert that we expect a `data.frame` (S3 class) object</span></span>
<span>  class <span class="op">=</span> <span class="st">"data.frame"</span>,</span>
<span></span>
<span>  <span class="co"># we'll only implement this for our cran_repo_resource</span></span>
<span>  for_resource <span class="op">=</span> <span class="va">cran_repo_resource</span>,</span>
<span></span>
<span>  <span class="kw">function</span><span class="op">(</span><span class="va">pkg</span>, <span class="va">...</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="fu">oysteR</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/oysteR/man/audit.html" class="external-link">audit</a></span><span class="op">(</span></span>
<span>      pkg <span class="op">=</span> <span class="va">pkg</span><span class="op">$</span><span class="va">name</span>,</span>
<span>      version <span class="op">=</span> <span class="va">pkg</span><span class="op">$</span><span class="va">version</span>,</span>
<span>      type <span class="op">=</span> <span class="st">"cran"</span>,</span>
<span>      verbose <span class="op">=</span> <span class="cn">FALSE</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>We can confirm our implementation by initializing a new
<code>pkg</code> object explicitly from a <code>CRAN</code> resource</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">r</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/cran_repo_resource.html">cran_repo_resource</a></span><span class="op">(</span><span class="st">"haven"</span>, <span class="st">"0.1.1"</span>, repo <span class="op">=</span> <span class="st">"https://cloud.r-project.org/"</span><span class="op">)</span></span>
<span><span class="va">p</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/pkg.html">pkg</a></span><span class="op">(</span><span class="va">r</span>, permissions <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="va">p</span><span class="op">$</span><span class="va">oysteR_vulnerability_df</span></span>
<span><span class="co">#&gt;   package version type          oss_package</span></span>
<span><span class="co">#&gt; 1   haven   0.1.1 cran pkg:cran/haven@0.1.1</span></span>
<span><span class="co">#&gt;                                                                                                                                                      description</span></span>
<span><span class="co">#&gt; 1 haven:  Import and Export 'SPSS', 'Stata' and 'SAS' Files\n\nImport foreign statistical formats into R via the embedded 'ReadStat' C library, &lt;https://github.</span></span>
<span><span class="co">#&gt;                                                                                                                 reference</span></span>
<span><span class="co">#&gt; 1 https://ossindex.sonatype.org/component/pkg:cran/haven@0.1.1?utm_source=oyster&amp;utm_medium=integration&amp;utm_content=0.1.1</span></span>
<span><span class="co">#&gt;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   vulnerabilities</span></span>
<span><span class="co">#&gt; 1 CVE-2018-11364, CVE-2018-11364, [CVE-2018-11364] CWE-772: Missing Release of Resource after Effective Lifetime, sav_parse_machine_integer_info_record in spss/readstat_sav_read.c in libreadstat.a in ReadStat 0.1.1 has a memory leak related to an iconv_open call., 7.5, CVSS:3.0/AV:N/AC:L/PR:N/UI:N/S:U/C:N/I:N/A:H, CWE-772, CVE-2018-11364, https://ossindex.sonatype.org/vulnerability/CVE-2018-11364?component-type=cran&amp;component-name=haven&amp;utm_source=oyster&amp;utm_medium=integration&amp;utm_content=0.1.1, http://web.nvd.nist.gov/view/vuln/detail?vulnId=CVE-2018-11364, https://github.com/ChijinZ/security_advisories/tree/master/ReadStat-7bced5b, CVE-2018-11365, CVE-2018-11365, [CVE-2018-11365] CWE-835: Loop with Unreachable Exit Condition ('Infinite Loop'), sas/readstat_sas7bcat_read.c in libreadstat.a in ReadStat 0.1.1 has an infinite loop., 7.5, CVSS:3.0/AV:N/AC:L/PR:N/UI:N/S:U/C:N/I:N/A:H, CWE-835, CVE-2018-11365, https://ossindex.sonatype.org/vulnerability/CVE-2018-11365?component-type=cran&amp;component-name=haven&amp;utm_source=oyster&amp;utm_medium=integration&amp;utm_content=0.1.1, http://web.nvd.nist.gov/view/vuln/detail?vulnId=CVE-2018-11365, https://github.com/ChijinZ/security_advisories/tree/master/ReadStat-7bced5b, CVE-2018-5698, CVE-2018-5698, [CVE-2018-5698] CWE-125: Out-of-bounds Read, libreadstat.a in WizardMac ReadStat 0.1.1 has a heap-based buffer over-read via an unterminated string., 7.8, CVSS:3.0/AV:L/AC:L/PR:N/UI:R/S:U/C:H/I:H/A:H, CWE-125, CVE-2018-5698, https://ossindex.sonatype.org/vulnerability/CVE-2018-5698?component-type=cran&amp;component-name=haven&amp;utm_source=oyster&amp;utm_medium=integration&amp;utm_content=0.1.1, http://web.nvd.nist.gov/view/vuln/detail?vulnId=CVE-2018-5698, https://github.com/WizardMac/ReadStat/issues/108</span></span>
<span><span class="co">#&gt;   no_of_vulnerabilities</span></span>
<span><span class="co">#&gt; 1                     3</span></span></code></pre></div>
<p>That looks good! We can double check that a few of our guardrails are
working as intended as well.</p>
<p>We can see that a generic repository will throw an error.</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">r</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/repo_resource.html">repo_resource</a></span><span class="op">(</span><span class="st">"haven"</span>, <span class="st">"0.1.1"</span>, repo <span class="op">=</span> <span class="st">"https://fakecran.org/"</span><span class="op">)</span></span>
<span><span class="va">p</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/pkg.html">pkg</a></span><span class="op">(</span><span class="va">r</span>, permissions <span class="op">=</span> <span class="st">"network"</span><span class="op">)</span></span>
<span><span class="va">p</span><span class="op">$</span><span class="va">oysteR_vulnerability_df</span></span>
<span><span class="co">#&gt; <span style="color: #0000BB; font-weight: bold;">&lt;error/val_meter_not_implemented_for_resource_error&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BBBB00;">!</span> data field "oysteR_vulnerability_df" could not be derived because it</span></span>
<span><span class="co">#&gt;   is not implemented for resource <span style="color: #0000BB;">&lt;val.meter::repo_resource&gt;</span></span></span></code></pre></div>
<p>And that not providing necessary permissions for network access will
similarly throw an error.</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">r</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/cran_repo_resource.html">cran_repo_resource</a></span><span class="op">(</span><span class="st">"haven"</span>, <span class="st">"0.1.1"</span>, repo <span class="op">=</span> <span class="st">"https://cloud.r-project.org/"</span><span class="op">)</span></span>
<span><span class="va">p</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/pkg.html">pkg</a></span><span class="op">(</span><span class="va">r</span><span class="op">)</span></span>
<span><span class="va">p</span><span class="op">$</span><span class="va">oysteR_vulnerability_df</span></span>
<span><span class="co">#&gt; <span style="color: #0000BB; font-weight: bold;">&lt;error/val_meter_derive_error&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BBBB00;">!</span> when deriving field "oysteR_vulnerability_df"</span></span>
<span><span class="co">#&gt; data derivation was not granted permissions: "network"</span></span></code></pre></div>
<p>And similarly, if we didn’t have <code>oysteR</code> installed we’d
see something like</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">r</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/cran_repo_resource.html">cran_repo_resource</a></span><span class="op">(</span><span class="st">"haven"</span>, <span class="st">"0.1.1"</span>, repo <span class="op">=</span> <span class="st">"https://cloud.r-project.org/"</span><span class="op">)</span></span>
<span><span class="va">p</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/pkg.html">pkg</a></span><span class="op">(</span><span class="va">r</span>, permissions <span class="op">=</span> <span class="st">"network"</span><span class="op">)</span></span>
<span><span class="va">p</span><span class="op">$</span><span class="va">oysteR_vulnerability_df</span></span></code></pre></div>
<pre><code><span><span class="co">#&gt; <span style="color: #0000BB; font-weight: bold;">&lt;error/val_meter_derive_error&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BBBB00;">!</span> when deriving field "oysteR_vulnerability_df"</span></span>
<span><span class="co">#&gt; data derivation requires suggests: <span style="color: #0000BB;">oysteR</span></span></span></code></pre>
<p>Now that we can fetch the <code>oysteR</code> response, we can
process it to derive our metric.</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/pkg_data.html">impl_data</a></span><span class="op">(</span></span>
<span>  <span class="st">"vulnerability_count"</span>,</span>
<span>  title <span class="op">=</span> <span class="st">"Number of Reported Vulnerabilities"</span>,</span>
<span>  description <span class="op">=</span> <span class="st">"Number of vulnerabilities reported for this package version"</span>,</span>
<span>  metric <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  class <span class="op">=</span> <span class="fu">S7</span><span class="fu">::</span><span class="va"><a href="https://rconsortium.github.io/S7/reference/base_classes.html" class="external-link">class_integer</a></span>,</span>
<span>  <span class="kw">function</span><span class="op">(</span><span class="va">pkg</span>, <span class="va">...</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">pkg</span><span class="op">$</span><span class="va">oysteR_vulnerability_df</span><span class="op">$</span><span class="va">no_of_vulnerabilities</span></span>
<span>  <span class="op">}</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>And if we try to use it, we’ll find that we get</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">r</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/cran_repo_resource.html">cran_repo_resource</a></span><span class="op">(</span><span class="st">"haven"</span>, <span class="st">"0.1.1"</span>, repo <span class="op">=</span> <span class="st">"https://cloud.r-project.org/"</span><span class="op">)</span></span>
<span><span class="va">p</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/pkg.html">pkg</a></span><span class="op">(</span><span class="va">r</span>, permissions <span class="op">=</span> <span class="st">"network"</span><span class="op">)</span></span>
<span><span class="va">p</span><span class="op">$</span><span class="va">vulnerability_count</span></span>
<span><span class="co">#&gt; [1] 3</span></span></code></pre></div>
<p>You may have noticed that we <em>didn’t</em> declare which resources
we were going to implement this metric for! By default, this means we’re
implementing it for <em>any</em> package resource. Let’s see what would
happen if we tried it for a non-CRAN resource:</p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">r</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/repo_resource.html">repo_resource</a></span><span class="op">(</span><span class="st">"haven"</span>, <span class="st">"0.1.1"</span>, repo <span class="op">=</span> <span class="st">"https://fakecran.org/"</span><span class="op">)</span></span>
<span><span class="va">p</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/pkg.html">pkg</a></span><span class="op">(</span><span class="va">r</span>, permissions <span class="op">=</span> <span class="st">"network"</span><span class="op">)</span></span>
<span><span class="va">p</span><span class="op">$</span><span class="va">vulnerability_count</span></span>
<span><span class="co">#&gt; <span style="color: #0000BB; font-weight: bold;">&lt;error/val_meter_derive_error&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BBBB00;">!</span> when deriving field "vulnerability_count"</span></span>
<span><span class="co">#&gt; data field "oysteR_vulnerability_df" could not be derived because it is not</span></span>
<span><span class="co">#&gt; implemented for resource <span style="color: #0000BB;">&lt;val.meter::repo_resource&gt;</span></span></span></code></pre></div>
<p>When attempting to calculate our count, we implicitly try to fetch
the internal <code>oysteR_vulnerability_df</code>, which itself is
limited to only CRAN repositories. We surface this error automatically
when we try to calculate a dependent metric.</p>
</div>
<div class="section level3">
<h3 id="simulating-metrics">Simulating metrics<a class="anchor" aria-label="anchor" href="#simulating-metrics"></a>
</h3>
<p>For developers, we appreciate being able to simulate reasonably
realistic packages for the purposes of examples, demonstration and
expediting development.</p>
<p>Already, we can take a look at what a simulated vulnerability count
might look like!</p>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">rpkg</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/random_pkg.html">random_pkg</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">rpkg</span><span class="op">$</span><span class="va">vulnerability_count</span></span>
<span><span class="co">#&gt; [1] 3</span></span></code></pre></div>
<p>Depending on the declared data type of metrics, we simulate data with
some simple default rules. We can take a look at what is being generated
over a sampling of random packages.</p>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/options.html">options</a></span><span class="op">(</span>val.meter.policy <span class="op">=</span> <span class="fu"><a href="../reference/policy.html">policy</a></span><span class="op">(</span>permissions <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">rpkgs</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/random_pkg.html">random_pkgs</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fl">100</span><span class="op">)</span></span>
<span><span class="va">rpkgs_df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html" class="external-link">as.data.frame</a></span><span class="op">(</span><span class="va">rpkgs</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/hist.html" class="external-link">hist</a></span><span class="op">(</span></span>
<span>  <span class="va">rpkgs_df</span><span class="op">$</span><span class="va">vulnerability_count</span>,</span>
<span>  main <span class="op">=</span> <span class="st">"Vulnerability Counts Tally"</span>,</span>
<span>  xlab <span class="op">=</span> <span class="st">"Number of Vulnerabilities"</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p><img src="adding-metric_files/figure-html/unnamed-chunk-24-1.svg" alt="A histogram of the default integer generating process, showing that nearly all packages show at least one vulnerability." width="672" style="display: block; margin: auto;"></p>
<p>Well this would be alarming! A majority of packages come with
vulnerabilities. This is definitely not reflective of the R ecosystem,
so maybe we want to tone that frequency down a bit.</p>
<p>We can implement our own derivation using <code>impl_data</code> once
again. This time, we want to register a method for a very specific
resource, the <code>mock_resource</code>. This resource is used for
random packages and allows us to use the exact same dispatch mechanism
to create a custom data-generating process.</p>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/pkg_data.html">impl_data</a></span><span class="op">(</span></span>
<span>  <span class="st">"vulnerability_count"</span>,</span>
<span>  for_resource <span class="op">=</span> <span class="va">mock_resource</span>,</span>
<span>  <span class="kw">function</span><span class="op">(</span><span class="va">...</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/stats/Poisson.html" class="external-link">rpois</a></span><span class="op">(</span><span class="fl">1</span>, lambda <span class="op">=</span> <span class="fl">0.1</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>If we again simulate some random packages and take a look at how many
vulnerabilities are reported we get something that is a bit closer to
reality.</p>
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">rpkgs</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/random_pkg.html">random_pkgs</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fl">100</span><span class="op">)</span></span>
<span><span class="va">rpkgs_df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html" class="external-link">as.data.frame</a></span><span class="op">(</span><span class="va">rpkgs</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/hist.html" class="external-link">hist</a></span><span class="op">(</span></span>
<span>  <span class="va">rpkgs_df</span><span class="op">$</span><span class="va">vulnerability_count</span>,</span>
<span>  main <span class="op">=</span> <span class="st">"Vulnerability Counts Tally"</span>,</span>
<span>  xlab <span class="op">=</span> <span class="st">"Number of Vulnerabilities"</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p><img src="adding-metric_files/figure-html/unnamed-chunk-26-1.svg" alt="Another histogram of package vulnerabilities after implementing our own simulation function. This time, the vast majority of packages have no vulnerabilities with only a handful reporting one or more vulnerabilities." width="672" style="display: block; margin: auto;"></p>
<p>Still higher than out in the wild, but perhaps a nice balance between
being reasonably frequent for the purpose of example, but still far less
than the half that we were seeing before.</p>
</div>
</div>
<div class="section level2">
<h2 id="contributing-metrics">Contributing metrics<a class="anchor" aria-label="anchor" href="#contributing-metrics"></a>
</h2>
<p>If you got this far implementing a metric on your own, why not reach
out to us so that we can share your work more broadly? The best place to
start is by heading to our issues tracker, easily accessed by running
<code>utils::bug.report(package = "val.meter")</code>.</p>
<p>We welcome all suggestions, even in a nascent state. We’ll work
together to decide exactly what should be distributed with
<code>val.meter</code>. We’ll often consider things like</p>
<ul>
<li>Whether we should be more restrictive about which resources can
calculate this metric.</li>
<li>Whether other resource types should get their own
implementations</li>
<li>If the metric requires additional dependencies, whether they are
slim enough to be merely suggested, or whether they come with enough of
a footprint to warrant a separate supporting package.</li>
</ul>
<p>Looking forward to hearing what you come up with!</p>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Doug Kelkhoff.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.3.</p>
</div>

    </footer>
</div>





  </body>
</html>
