<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Internals Overview • val.meter</title>
<script src="../lightswitch.js"></script><script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Internals Overview">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top " aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">val.meter</a>

    <small class="nav-text text-danger me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="Unreleased version">0.0.0.9000</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/adding-metric.html">Adding a Metric</a></li>
    <li><a class="dropdown-item" href="../articles/internals-overview.html">Internals Overview</a></li>
    <li><a class="dropdown-item" href="../articles/repository-integrations.html">Repository Integrations</a></li>
    <li><a class="dropdown-item" href="../articles/riskmetric-comparison.html">riskmetric Comparison</a></li>
  </ul>
</li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/pharmaR/val.meter/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-lightswitch" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true" aria-label="Light switch"><span class="fa fa-sun"></span></button>
  <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="dropdown-lightswitch">
<li><button class="dropdown-item" data-bs-theme-value="light"><span class="fa fa-sun"></span> Light</button></li>
    <li><button class="dropdown-item" data-bs-theme-value="dark"><span class="fa fa-moon"></span> Dark</button></li>
    <li><button class="dropdown-item" data-bs-theme-value="auto"><span class="fa fa-adjust"></span> Auto</button></li>
  </ul>
</li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Internals Overview</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/pharmaR/val.meter/blob/main/vignettes/internals-overview.Rmd" class="external-link"><code>vignettes/internals-overview.Rmd</code></a></small>
      <div class="d-none name"><code>internals-overview.Rmd</code></div>
    </div>

    
    
<style type="text/css">
[data-bs-theme="dark"] main img {
  filter: invert(1);
}
</style>
<p>Welcome to <code>val.meter</code>! If we’re going to explore the
internals of the package, the best place to start is the
<code>./R</code> directory! If you take a peek in there you’ll see a few
common prefixes, so let’s start by breaking those down.</p>
<ul>
<li>
<code>utils_*</code>: Supporting functions for making some other
tailoring other packages to our internal needs. These are pretty
low-level, but hopefully aren’t too mysterious.</li>
<li>
<code>class_*</code>: <code>S7</code> class definitions and their
methods</li>
<li>
<code>generic_*</code>: <code>S7</code> generics</li>
<li>
<code>data_*</code>: Package data and metric implementations. File
names should reflect the field name or most central field for a batch of
fields.</li>
<li>
<code>impl_*</code>: Tools for implementing data field methods.</li>
</ul>
<p>There are a few other miscellaneous files like
<code>options.R</code>, <code>package.R</code> and <code>zzz.R</code>,
but these should be pretty self explanatory.</p>
<p>We’ll walk through the important concepts, largely following these
high-level file prefix categories, in more detail below.</p>
<div class="section level2">
<h2 id="s7-classes">
<code>S7</code> Classes<a class="anchor" aria-label="anchor" href="#s7-classes"></a>
</h2>
<p><code>val.meter</code> leverages <code>S7</code> extensively to
organize its data and methods. <code>S7</code> classes offer far better
control over data types and their type hierarchies to improve the
stability of <code>val.meter</code> functions and <code>S7</code>
generics allow for more granular dispatch on classes and multiple
dispatch out-of-the-box.</p>
<p><code>S7</code> is still maturing, so it’s worth acknowledging that
it comes with some (currently) unavoidable hurdles. After an assessment
period, we decided these shortcomings did not outweigh the benefits it
brings.</p>
<p><code>val.meter</code> provides a handful of classes, representing
the foundational data types of the package.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://r.igraph.org/" class="external-link">igraph</a></span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Attaching package: 'igraph'</span></span>
<span><span class="co">#&gt; The following objects are masked from 'package:stats':</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;     decompose, spectrum</span></span>
<span><span class="co">#&gt; The following object is masked from 'package:base':</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;     union</span></span>
<span></span>
<span><span class="co"># since we're all developers, don't mind me taking a peek behind the curtain</span></span>
<span><span class="va">val_meter</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/ns-reflect.html" class="external-link">getNamespace</a></span><span class="op">(</span><span class="st">"val.meter"</span><span class="op">)</span></span>
<span><span class="va">g</span> <span class="op">&lt;-</span> <span class="va">val_meter</span><span class="op">$</span><span class="fu">class_graph</span><span class="op">(</span><span class="st">"val.meter"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># do some slight class renaming to make them easier to read</span></span>
<span><span class="fu"><a href="https://r.igraph.org/reference/V.html" class="external-link">V</a></span><span class="op">(</span><span class="va">g</span><span class="op">)</span><span class="op">$</span><span class="va">label</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/strsplit.html" class="external-link">strsplit</a></span><span class="op">(</span><span class="fu"><a href="https://r.igraph.org/reference/V.html" class="external-link">V</a></span><span class="op">(</span><span class="va">g</span><span class="op">)</span><span class="op">$</span><span class="va">class</span>, <span class="st">"_"</span><span class="op">)</span>, <span class="va">paste</span>, collapse <span class="op">=</span> <span class="st">"\n"</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/par.html" class="external-link">par</a></span><span class="op">(</span>mar <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0</span>, <span class="fl">0</span>, <span class="fl">0</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span></span>
<span>  <span class="va">g</span>,</span>
<span>  layout <span class="op">=</span> <span class="fu"><a href="https://r.igraph.org/reference/layout_with_graphopt.html" class="external-link">layout_with_graphopt</a></span><span class="op">(</span></span>
<span>    <span class="va">g</span>,</span>
<span>    niter <span class="op">=</span> <span class="fl">5000</span>,</span>
<span>    charge <span class="op">=</span> <span class="fl">0.2</span>,</span>
<span>    spring.length <span class="op">=</span> <span class="fl">4</span>,</span>
<span>    spring.constant <span class="op">=</span> <span class="fl">8</span></span>
<span>  <span class="op">)</span>,</span>
<span>  vertex.size <span class="op">=</span> <span class="fl">30</span>,</span>
<span>  vertex.frame.color <span class="op">=</span> <span class="cn">NA</span>,</span>
<span>  vertex.label <span class="op">=</span> <span class="fu"><a href="https://r.igraph.org/reference/V.html" class="external-link">V</a></span><span class="op">(</span><span class="va">g</span><span class="op">)</span><span class="op">$</span><span class="va">label</span>,</span>
<span>  vertex.label.dist <span class="op">=</span> <span class="fl">0</span>,</span>
<span>  vertex.label.degree <span class="op">=</span> <span class="op">-</span><span class="va">pi</span> <span class="op">/</span> <span class="fl">2</span>,</span>
<span>  vertex.label.family <span class="op">=</span> <span class="st">"sans-serif"</span>,</span>
<span>  vertex.label.cex <span class="op">=</span> <span class="fl">0.6</span>,</span>
<span>  vertex.label.color <span class="op">=</span> <span class="st">"grey8"</span>,</span>
<span>  edge.arrow.size <span class="op">=</span> <span class="fl">0.25</span>,</span>
<span>  vertex.color <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html" class="external-link">ifelse</a></span><span class="op">(</span><span class="fu"><a href="https://r.igraph.org/reference/V.html" class="external-link">V</a></span><span class="op">(</span><span class="va">g</span><span class="op">)</span><span class="op">$</span><span class="va">abstract</span>, <span class="st">"grey"</span>, <span class="st">"lightblue"</span><span class="op">)</span>,</span>
<span><span class="op">)</span></span></code></pre></div>
<p><img src="internals-overview_files/figure-html/unnamed-chunk-3-1.svg" class="r-plt" alt="A class relationship graph, showcasing the various S7 classes used throughout val.meter. There is a cluster of resource classes, showing the hierarchy of resource classes (including abstract classes), as well as a large set of standalone classes." width="768" style="display: block; margin: auto;"></p>
<p>So that’s a lot to take in, but let’s break down what we’re seeing.
First, there’s a large cluster of <code>resource</code> classes. These
account for over half of the classes that <code>val.meter</code>
exports.</p>
<p>Similarly, there’s a set of classes that are really just wrappers
around base types. <code>permissions</code>, <code>tags</code> and
<code>suggests</code> are just <code>character</code> vectors with a bit
of <code>S7</code> sprinkled on top to do some type checking and ensure
consistency.</p>
<p>And just like that, we’re down to only a small set of classes that we
really need to concern ourselves with.</p>
<ul>
<li>
<code>data_info</code> and <code>data_info_list</code>:
<code>data_info</code> is the more important one of the two, and is used
to provide structure to package data metadata.
<code>data_info_list</code> is only used for formatting console
output.</li>
<li>
<code>policy</code>: This class is a user-facing object used for
specifying the policies for how resources are discovered and what
capabilities execution should have.</li>
<li>And last but certainly not least, <code>pkg</code> is the workhorse
of <code>val.meter</code>. It binds a set of resource for collecting
data with the data they produced.</li>
</ul>
<p>Since we’ll be exploring the internals of <code>val.meter</code>,
we’re going to load our entire package namespace.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">pkgload</span><span class="fu">::</span><span class="fu"><a href="https://pkgload.r-lib.org/reference/load_all.html" class="external-link">load_all</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="s7-generics">
<code>S7</code> Generics<a class="anchor" aria-label="anchor" href="#s7-generics"></a>
</h2>
<p>In addition to a swath of classes, <code>val.meter</code> adds a few
<code>S7</code> generics. Briefly, <em>generics</em> are functions that
change their behavior depending on the class of the arguments, arriving
at the actual function to be executed through a process called
<em>method dispatch</em>.</p>
<p>There are two central generics that provide the core functionality of
<code>val.meter</code>: <code><a href="../reference/pkg_data_derive.html">pkg_data_derive()</a></code> and
<code><a href="../reference/pkg_data_info.html">pkg_data_info()</a></code>. These describe the behavior and metadata
of derived package data.</p>
<p>The functions themselves are not too cumbersome, but <em>how</em>
they’re used might be a bit of a barrier if you find yourself diving
deep into debugging the package. The reason for this lies in how we want
developers to work. When we write metrics, we want developers to be able
to write code that is straightforward, intuitive and easy to read.</p>
<p>We can derive some data for a package using just a package object and
a “field” (the name for the data in the package object):</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">rpkg</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/random_pkg.html">random_pkg</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/pkg_data_derive.html">pkg_data_derive</a></span><span class="op">(</span>pkg <span class="op">=</span> <span class="va">rpkg</span>, field <span class="op">=</span> <span class="st">"r_cmd_check_error_count"</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 0</span></span></code></pre></div>
<p>Let’s see what code was needed to implement this</p>
<pre><code><span><span class="co">#&gt; function (pkg, resource, ...) </span></span>
<span><span class="co">#&gt; {</span></span>
<span><span class="co">#&gt;     length(pkg$r_cmd_check$errors)</span></span>
<span><span class="co">#&gt; }</span></span>
<span><span class="co">#&gt; &lt;environment: namespace:val.meter&gt;</span></span></code></pre>
<p>This code is pretty straightforward! We can count on
<code>pkg$r_cmd_check</code> existing, and we only needed to tease out
the errors. We’ll get to the details of how this works down in the
section on <a href="#lazy">lazy evaluation</a>, but for now we can see
that this generic let us keep the implementation details rather
straightforward.</p>
</div>
<div class="section level2">
<h2 id="lazy">Lazy Evaluation<a class="anchor" aria-label="anchor" href="#lazy"></a>
</h2>
<p>As mentioned, <code>S7</code> dispatch (with a little <code>S3</code>
thrown in for good measure), is the powerhouse behind simple metric
implementations.</p>
<div class="section level3">
<h3 id="lazy-lists">Lazy <code>list</code>s<a class="anchor" aria-label="anchor" href="#lazy-lists"></a>
</h3>
<p><code>pkg</code> objects are <code>S7</code> objects. <code>S7</code>
objects have <em>properties</em> that are accessed using the
<code>@</code> operator. In fact, the <code>pkg</code> does too! But in
most cases, we’re more concerned with how it masquerades as a
<code>list</code>, exposing data through the <code>$</code> operator (or
your choice of <code>[["name"]]</code> or <code>[c("names")]</code> just
like an ordinary list).</p>
<p><code>pkg</code> objects go to quite some lengths to convince you
they’re lists! They have tab completion, print out their contents
<em>almost</em> like a <code>list</code> and you can grab their
<code>list</code>-like entries using <code><a href="https://rdrr.io/r/base/names.html" class="external-link">names()</a></code>.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">rpkg</span><span class="op">)</span></span>
<span><span class="co">#&gt;  [1] "r_cmd_check"             "desc"                   </span></span>
<span><span class="co">#&gt;  [3] "archive_md5"             "vignette_count"         </span></span>
<span><span class="co">#&gt;  [5] "web_html"                "web_url"                </span></span>
<span><span class="co">#&gt;  [7] "name"                    "version"                </span></span>
<span><span class="co">#&gt;  [9] "r_cmd_check_error_count" "downloads_total"        </span></span>
<span><span class="co">#&gt; [11] "dependency_count"        "has_website"</span></span></code></pre></div>
<p>Yep. There they are. All the fields you can just <em>assume</em>
exist in this <code>pkg</code> object. We say <em>“assume”</em> because
they don’t actually exist in the <code>pkg</code> - at least not yet.
This <code>list</code> is exceptionally lazy and will only work if it
absolutely has to. This is a nice quality for us, since we also only
want to wait as long as we absolutely have to to get the data we care
about.</p>
<p>If we take a peek at our <code>rpkg</code> object, we’ll see:</p>
<pre><code><span><span class="co">#&gt; &lt;val.meter::pkg&gt;</span></span>
<span><span class="co">#&gt; @resource</span></span>
<span><span class="co">#&gt;   &lt;val.meter::mock_resource&gt;</span></span>
<span><span class="co">#&gt;    @ package: chr "quaintwellbeing"</span></span>
<span><span class="co">#&gt;    @ version: chr "3.1.5"</span></span>
<span><span class="co">#&gt;    @ id     : int 1</span></span>
<span><span class="co">#&gt;    @ md5    : chr "f1c516596e9ad5015218ead8114487d5"</span></span>
<span><span class="co">#&gt; @permissions</span></span>
<span><span class="co">#&gt;   &lt;val.meter::permissions&gt; chr [1:3] "write" "execution" "network"</span></span>
<span><span class="co">#&gt; $vignette_count</span></span>
<span><span class="co">#&gt;   &lt;promise&gt;</span></span>
<span><span class="co">#&gt; $r_cmd_check_error_count</span></span>
<span><span class="co">#&gt;   &lt;promise&gt;</span></span>
<span><span class="co">#&gt; $downloads_total</span></span>
<span><span class="co">#&gt;   &lt;promise&gt;</span></span>
<span><span class="co">#&gt; $dependency_count</span></span>
<span><span class="co">#&gt;   &lt;promise&gt;</span></span>
<span><span class="co">#&gt; $has_website</span></span>
<span><span class="co">#&gt;   &lt;promise&gt;</span></span>
<span><span class="co">#&gt; $r_cmd_check (internal)</span></span>
<span><span class="co">#&gt; $desc (internal)</span></span>
<span><span class="co">#&gt; $archive_md5 (internal)</span></span>
<span><span class="co">#&gt; $web_html (internal)</span></span>
<span><span class="co">#&gt; $web_url (internal)</span></span>
<span><span class="co">#&gt; $name (internal)</span></span>
<span><span class="co">#&gt; $version (internal)</span></span></code></pre>
<p>You’ll see that there’s a lot of data missing in there, but that
doesn’t mean we can’t use it! If we try to use one of these fields we’ll
get some data out.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">rpkg</span><span class="op">$</span><span class="va">r_cmd_check_error_count</span></span>
<span><span class="co">#&gt; [1] 0</span></span></code></pre></div>
<p>And if we look at our object again, we’ll see that it suddenly has
some new data.</p>
<pre><code><span><span class="co">#&gt; &lt;val.meter::pkg&gt;</span></span>
<span><span class="co">#&gt; @resource</span></span>
<span><span class="co">#&gt;   &lt;val.meter::mock_resource&gt;</span></span>
<span><span class="co">#&gt;    @ package: chr "quaintwellbeing"</span></span>
<span><span class="co">#&gt;    @ version: chr "3.1.5"</span></span>
<span><span class="co">#&gt;    @ id     : int 1</span></span>
<span><span class="co">#&gt;    @ md5    : chr "f1c516596e9ad5015218ead8114487d5"</span></span>
<span><span class="co">#&gt; @permissions</span></span>
<span><span class="co">#&gt;   &lt;val.meter::permissions&gt; chr [1:3] "write" "execution" "network"</span></span>
<span><span class="co">#&gt; $vignette_count</span></span>
<span><span class="co">#&gt;   &lt;promise&gt;</span></span>
<span><span class="co">#&gt; $r_cmd_check_error_count</span></span>
<span><span class="co">#&gt;   [1] 0</span></span>
<span><span class="co">#&gt; $downloads_total</span></span>
<span><span class="co">#&gt;   &lt;promise&gt;</span></span>
<span><span class="co">#&gt; $dependency_count</span></span>
<span><span class="co">#&gt;   &lt;promise&gt;</span></span>
<span><span class="co">#&gt; $has_website</span></span>
<span><span class="co">#&gt;   &lt;promise&gt;</span></span>
<span><span class="co">#&gt; $r_cmd_check (internal)</span></span>
<span><span class="co">#&gt; $desc (internal)</span></span>
<span><span class="co">#&gt; $archive_md5 (internal)</span></span>
<span><span class="co">#&gt; $web_html (internal)</span></span>
<span><span class="co">#&gt; $web_url (internal)</span></span>
<span><span class="co">#&gt; $name (internal)</span></span>
<span><span class="co">#&gt; $version (internal)</span></span></code></pre>
<p>After we accessed our data, the package object did the work to
compute it. In fact, it also computed any necessary dependent data like
the <code>r_cmd_check</code> results themselves - whatever was necessary
to give us the data we wanted. If any errors or constraints prevented us
from calculating dependent data, those errors would be surfaced through
to us here as well.</p>
</div>
<div class="section level3">
<h3 id="dispatch-for-lazy-evaluation">Dispatch for lazy evaluation<a class="anchor" aria-label="anchor" href="#dispatch-for-lazy-evaluation"></a>
</h3>
<p>Now let’s learn about how this is achieved. The first part is easy. A
<code>pkg</code> contains an environment that gets iteratively populated
as fields are requested.</p>
<p>But what happens when a field is requested? We call
<code>rpkg$r_cmd_check_error_count</code>, but what happens then? This
is where <code>S7</code> comes in. To make sure that we’re deriving this
data for the right types of package resources, we dispatch on the
package, resource type and field, arriving at a specialized function for
precisely the type of package we have. The astute reader will notice
that the field name, in this case <code>"r_cmd_check_error_count"</code>
isn’t a class at all, it will always be a <code>class_character</code> -
so how does that help us?</p>
<p>Well we <em>do</em> dispatch on <code>class_character</code>, but we
immediately use that character value to create a unique class name based
on the field name that allows us to dispatch to a unique function. We
can take a look under the hood at exactly what code gets run:</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rconsortium.github.io/S7/reference/method.html" class="external-link">method</a></span><span class="op">(</span><span class="va">pkg_data_derive</span>, <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">pkg</span>, <span class="va">class_any</span>, <span class="va">class_character</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; &lt;S7_method&gt; method(pkg_data_derive, list(class_any, class_any, class_character))</span></span>
<span><span class="co">#&gt; function (pkg, resource, field, ..., field_name) </span></span>
<span><span class="co">#&gt; {</span></span>
<span><span class="co">#&gt;     pkg_data_derive(pkg, resource = NULL, field = as_pkg_data(field), </span></span>
<span><span class="co">#&gt;         ..., field_name = field)</span></span>
<span><span class="co">#&gt; }</span></span>
<span><span class="co">#&gt; &lt;environment: namespace:val.meter&gt;</span></span></code></pre></div>
<p>As you can see, we immediately recurse, but given a new
<code>field</code> parameter: a data-less object with a class for
dispatch. In our case, this would be</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/pkg_data_dispatch.html">as_pkg_data</a></span><span class="op">(</span><span class="st">"r_cmd_check_error_count"</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "r_cmd_check_error_count"</span></span>
<span><span class="co">#&gt; attr(,"class")</span></span>
<span><span class="co">#&gt; [1] "pkg_data_field_r_cmd_check_error_count"</span></span>
<span><span class="co">#&gt; [2] "pkg_data_field"</span></span></code></pre></div>
<p>With a unique class name, we can dispatch down to the unique method
that will help us derive this particular type of data.</p>
</div>
<div class="section level3">
<h3 id="error-handling-during-lazy-evaluation">Error handling during lazy evaluation<a class="anchor" aria-label="anchor" href="#error-handling-during-lazy-evaluation"></a>
</h3>
<p>We glossed over one small detail. We don’t actually call
<code>pkg_data_derive</code> directly when we access data through
<code>pkg$field</code>. Instead, we call <code>get_pkg_data</code>,
which wraps calls to <code>pkg_data_derive</code> with a little bit of
error handling.</p>
<p>This additional layer is critical, because it helps us capture errors
if they occur and capture relationships and dependencies between data.
For example, if we want to calculate
<code>pkg$r_cmd_check_error_count</code>, which depends on
<code>pkg$r_cmd_check</code>, we don’t want errors to be thrown
immediately. Instead, we want to record the fact that an error was
thrown when running <code>r_cmd_check</code> and then indicate that
<code>r_cmd_check_error_count</code> wasn’t able to be calculated
because of this data dependency.</p>
<p>Let’s see what it would look like if this were to occur.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">r</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/install_resource.html">install_resource</a></span><span class="op">(</span>path <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/find.package.html" class="external-link">find.package</a></span><span class="op">(</span><span class="st">"val.meter"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">p</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/pkg.html">pkg</a></span><span class="op">(</span><span class="va">r</span><span class="op">)</span></span>
<span><span class="va">p</span><span class="op">$</span><span class="va">name</span></span></code></pre></div>
<pre><code><span><span class="co">#&gt; <span style="color: #0000BB; font-weight: bold;">&lt;error/val_meter_derive_dependency_error&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BBBB00;">!</span> field depends on field "desc" that threw an error during derivation</span></span></code></pre>
<p>Sure enough, we can see that we’ve evaluated the internal field,
<code>"desc"</code>, which produced a (mocked) error and prevented us
from completing calculation of our package name. We can confirm by
looking at the internal <code>"desc"</code> data:</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">p</span><span class="op">$</span><span class="va">desc</span></span>
<span><span class="co">#&gt; <span style="color: #0000BB; font-weight: bold;">&lt;error/val_meter_derive_error&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BBBB00;">!</span> when deriving field "desc"</span></span>
<span><span class="co">#&gt; mocked error in desc::desc</span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="error-types">Error types<a class="anchor" aria-label="anchor" href="#error-types"></a>
</h2>
<p>For consistency, internally most errors are raised through the
pre-specified error types in <code>err$</code> (if you see anything that
<em>could</em> be generalized, please add the error type!). This has a
few key benefits. The messaging is consistent across various errors, we
can focus all the call stack handling in one place, and we can recreate
errors easily when parsed back from a <code>PACKAGES</code> file.</p>
<p>Robust error handling is key to good reporting, so we want to be sure
to give errors a designated class and report errors in a way where they
provide effective context for why the error was raised.</p>
<p>You may discover the very conveniently named <code><a href="../reference/error.html">error()</a></code>
function. It would be reasonable to assume that this is how errors
should be constructed. However, this function is intended only for
serialization. When we write errors out to a <code>PACKAGES</code> file
we want something succinct and reproducible. An error type such as</p>
<pre><code><span><span class="co">#&gt; <span style="color: #0000BB; font-weight: bold;">&lt;error/val_meter_missing_suggests_error&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BBBB00;">!</span> data derivation requires suggests: <span style="color: #0000BB;">abc</span></span></span></code></pre>
<p>will be written out as:</p>
<pre class="dcf"><code><span><span class="va">Metric</span><span class="op">/</span><span class="va">abc</span><span class="op">@</span><span class="va">R</span><span class="op">:</span> <span class="fu"><a href="../reference/error.html">error</a></span><span class="op">(</span><span class="st">"missing_suggests"</span>, <span class="st">"abc"</span><span class="op">)</span></span></code></pre>
<p>When we parse this file back into a <code>pkg</code> object, we can
easily re-construct our error (barring the original callstack) by simply
evaluating this little snippet.</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/eval.html" class="external-link">eval</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/parse.html" class="external-link">parse</a></span><span class="op">(</span>text <span class="op">=</span> <span class="st">'error("missing_suggests", "abc")'</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #0000BB; font-weight: bold;">&lt;error/val_meter_missing_suggests_error&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BBBB00;">!</span> data derivation requires suggests: <span style="color: #0000BB;">abc</span></span></span></code></pre></div>
<p>Where <code>err$missing_suggets</code> captures additional
information about the calling frame to provide an effective traceback,
reproducing this error only reconstructs the messaging.</p>
</div>
<div class="section level2">
<h2 id="data-simulation">Data simulation<a class="anchor" aria-label="anchor" href="#data-simulation"></a>
</h2>
<p>In order to build effective mock packages for testing and example, we
also provide features for generating convincing fake data. We leverage
the same internals that we do for deriving all the real package data,
but dispatch on a <code>mock_resource</code> which allows us to fall
back to artificial data generating methods.</p>
<p>We also bundle a dataset of package names derived from a word list of
words with positive connotations and a handful of common R package
naming convention patterns.</p>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Doug Kelkhoff.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.2.0.</p>
</div>

    </footer>
</div>





  </body>
</html>
